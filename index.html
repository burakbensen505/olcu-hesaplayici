<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensar Mobilya - Geliştirilmiş Proje Hesaplayıcı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Teko:wght@600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .logo { font-family: 'Teko', sans-serif; }
        .input-group label, .select-group label { display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 500; font-size: 0.875rem; }
        .input-group input, .select-group select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-group input:focus, .select-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .btn { padding: 0.6rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; text-align: center; }
        .btn-full { width: 100%; }
        .btn-auto { width: auto; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem;}
        .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); height: 100%; }
    </style>
</head>
<body class="p-4 lg:p-6">

    <header class="max-w-screen-2xl mx-auto mb-6 flex justify-between items-center"><div class="logo text-4xl text-gray-800">ENSAR MOBİLYA</div><div class="text-center"><h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Proje Bazlı Dolap Hesaplayıcı</h1></div><div></div></header>

    <div class="max-w-screen-2xl mx-auto"><div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-3"><div class="card">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4">Yeni Kabin Ekle</h2>
            <div class="space-y-4">
                <div class="select-group"><label for="kabinTipi">Kabin Tipi</label><select id="kabinTipi" onchange="kabinTipiDegisti()"><option value="standart" selected>Standart Kapaklı</option><option value="cekmeceli">Çekmeceli</option></select></div>
                <div class="input-group"><label for="kabinAdi">Kabin Adı</label><input type="text" id="kabinAdi" value="Alt Modül"></div>
                <div class="grid grid-cols-2 gap-3">
                   <div class="input-group"><label for="genislik">Genişlik(cm)</label><input type="number" id="genislik" value="60"></div>
                   <div class="input-group"><label for="yukseklik">Yükseklik(cm)</label><input type="number" id="yukseklik" value="72"></div>
                   <div class="input-group"><label for="derinlik">Derinlik(cm)</label><input type="number" id="derinlik" value="56"></div>
                   <div id="rafInputDiv" class="input-group"><label for="rafSayisi">Raf Sayısı</label><input type="number" id="rafSayisi" value="1"></div>
                   <div id="cekmeceInputDiv" class="hidden input-group"><label for="cekmeceSayisi">Çekmece Sayısı</label><input type="number" id="cekmeceSayisi" value="3"></div>
                </div>
                <div class="select-group"><label for="arkalikTipi">Arkalık Tipi</label><select id="arkalikTipi"><option value="kanalli" selected>Kanallı (İçe Sıfır)</option><option value="icte">Komple İçten</option></select></div>
                <div class="pt-4"><button onclick="kabiniEkle()" class="btn btn-full btn-primary">Kabini Projeye Ekle</button></div>
            </div>
        </div></div>
        <div class="lg:col-span-3"><div class="card"><h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4">Proje Kabinleri</h2><div id="projeListesi" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>
        <div class="lg:col-span-6"><div class="card">
            <div class="flex flex-wrap justify-between items-center border-b pb-3 mb-4 gap-2"><h2 class="text-xl font-semibold text-gray-700">Genel Kesim Listesi</h2><button onclick="hesaplaGlobal()" class="btn btn-auto btn-secondary">Hesapla ve Öneri Al</button></div>
            <div id="plakaOneriKutusu" class="hidden p-3 mb-4 bg-blue-50 border border-blue-200 rounded-lg text-center"><h3 class="font-semibold text-blue-800">Akıllı Plaka Önerisi</h3><p id="plakaOneriMetni" class="text-sm text-blue-700 my-1"></p><button id="plakaOneriUygulaBtn" class="btn btn-auto btn-success text-xs px-3 py-1">Bu Öneriyi Kullan</button></div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div><h3 class="font-semibold text-gray-600 mb-2">Toplam Parça Listesi</h3><div class="overflow-auto max-h-[50vh]"><table class="w-full text-left text-sm"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-2 font-semibold text-gray-600">Adet</th><th class="p-2 font-semibold text-gray-600">Parça Adı</th><th class="p-2 font-semibold text-gray-600">Ölçü (BoyxEn)</th></tr></thead><tbody id="kesimListesiBody"></tbody></table></div></div>
                <div><div class="flex items-center justify-between mb-2"><h3 class="font-semibold text-gray-600">Optimizasyon Şeması</h3><div id="optimizasyonBilgi" class="text-sm text-right"></div></div><div id="canvasContainer" class="bg-gray-200 rounded-md overflow-hidden relative w-full"><canvas id="kesimSemasiCanvas"></canvas></div></div>
            </div>
        </div></div>
    </div></div>
    <footer class="text-center mt-8 text-sm text-gray-500"><p>Ahmet Burak Karakuş tarafından yapılmıştır.</p></footer>

    <script>
        var potpack=function(){"use strict";return function(t,o,i){var n=t.length,r=o||0,s=i||0;if(r&&s)for(var e=0;e<n;e++){var h=t[e];h.w>r||h.h>s||(h.pack=!0)}t.sort(function(t,o){return o.h-t.h});var a={w:0,h:0,fill:0};if(!r||!s){for(var e=0;e<n;e++)a.w=Math.max(a.w,t[e].w),a.h+=t[e].h;return r=a.w,s=a.h,a}for(var p=[{x:0,y:0,w:r,h:s}],c=0;c<n;c++){for(var u=t[c],l=-1,f=1/0,d=0;d<p.length;d++){var v=p[d];if(!(u.w>v.w||u.h>v.h)){var g=Math.min(v.w-u.w,v.h-u.h);g<f&&(f=g,l=d)}}if(-1===l)continue;var v=p.splice(l,1)[0];u.x=v.x,u.y=v.y,u.w<v.w&&p.push({x:v.x+u.w,y:v.y,w:v.w-u.w,h:u.h}),u.h<v.h&&p.push({x:v.x,y:v.y+u.h,w:v.w,h:v.h-u.h})}return a.w=r,a.h=s,a.fill=(t.reduce(function(t,o){return t+(o.pack?o.w*o.h:0)},0)||0)/(r*s),a}}();

        let projeKabinleri = [];
        let mevcutPlaka = { w: 183, h: 366 };
        const malzemeKalinligi = 18;
        const standartPlakalar = [{ ad: "Standart Büyük", w: 183, h: 366, alan: 67000 },{ ad: "Standart Orta", w: 210, h: 280, alan: 58800 },{ ad: "Yarım Plaka", w: 122, h: 244, alan: 29768 },{ ad: "Geniş Plaka", w: 210, h: 366, alan: 76860 }];

        function kabinTipiDegisti() {
            const tip = document.getElementById('kabinTipi').value;
            const rafDiv = document.getElementById('rafInputDiv');
            const cekmeceDiv = document.getElementById('cekmeceInputDiv');
            const kabinAdiInput = document.getElementById('kabinAdi');
            if (tip === 'cekmeceli') {
                rafDiv.classList.add('hidden');
                cekmeceDiv.classList.remove('hidden');
                kabinAdiInput.value = "Çekmeceli Modül";
            } else {
                rafDiv.classList.remove('hidden');
                cekmeceDiv.classList.add('hidden');
                kabinAdiInput.value = "Alt Modül";
            }
        }
        
        function kabiniEkle() {
            projeKabinleri.push({id: Date.now(), tip: document.getElementById('kabinTipi').value, ad: document.getElementById('kabinAdi').value || 'İsimsiz', gen: parseFloat(document.getElementById('genislik').value), yuk: parseFloat(document.getElementById('yukseklik').value), der: parseFloat(document.getElementById('derinlik').value), raf: parseInt(document.getElementById('rafSayisi').value), cekmece: parseInt(document.getElementById('cekmeceSayisi').value), arkalikTipi: document.getElementById('arkalikTipi').value});
            projeyiGoster();
        }
        
        function kabiniSil(id) {
            projeKabinleri = projeKabinleri.filter(k => k.id !== id);
            projeyiGoster();
            hesaplaGlobal();
        }

        function projeyiGoster() {
            const listeEl = document.getElementById('projeListesi');
            listeEl.innerHTML = '';
            if (projeKabinleri.length === 0) {
                listeEl.innerHTML = '<p class="text-gray-500 text-center p-4">Henüz proje yok.</p>';
                document.getElementById('kesimListesiBody').innerHTML = '';
                const ctx = document.getElementById('kesimSemasiCanvas').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                document.getElementById('optimizasyonBilgi').innerHTML = '';
                document.getElementById('plakaOneriKutusu').classList.add('hidden');
            } else {
                 projeKabinleri.forEach(k => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg bg-gray-50 flex justify-between items-center';
                    div.innerHTML = `<div><p class="font-semibold">${k.ad} (${k.tip})</p><p class="text-xs text-gray-600">${k.gen}x${k.yuk}x${k.der} cm</p></div><button onclick="kabiniSil(${k.id})" class="btn-danger">Sil</button>`;
                    listeEl.appendChild(div);
                });
            }
        }
        
        function hesaplaGlobal(){
            const kalinlikCm = malzemeKalinligi / 10;
            const fugaCm = 0.2; // 2mm kapak arası boşluk
            const rayBoslukCm = 2.6; // Her iki yan toplam 26mm ray boşluğu
            
            let tumParcalar = projeKabinleri.flatMap(kabin => {
                let parcalar = [];
                // AÇIKLAMA: Gövde iç ölçüleri, yan dikmelerin arasına giren üst ve alt tablalara göre hesaplanır. Bu standart bir yöntemdir.
                const icGenislik = kabin.gen - (kalinlikCm * 2);
                const icYukseklik = kabin.yuk - (kalinlikCm * 2);

                // Gövde Parçaları (Her Tip İçin Ortak)
                parcalar.push({ h: kabin.yuk, w: kabin.der, count: 2, ad: 'Yan Dikme'});
                parcalar.push({ h: icGenislik, w: kabin.der, count: 2, ad: 'Alt/Üst Tabla' });
                
                // Arkalık Hesaplaması
                let arkalikGen, arkalikYuk;
                // AÇIKLAMA: 'Kanallı (İçe Sıfır)' seçeneği, arkalığın gövdenin iç ölçüleri ile aynı boyutta olduğunu ve genellikle yan/alt/üst tablalara açılan kanala girdiğini varsayar.
                // Bu yüzden 'içte' ve 'kanallı' seçenekleri aynı sonucu verir. Eğer arkalığı dıştan çakmak isterseniz (sandık tipi), aşağıdaki gibi bir kod kullanabilirsiniz:
                // arkalikGen = kabin.gen; arkalikYuk = kabin.yuk;
                if (kabin.arkalikTipi === 'icte' || kabin.arkalikTipi === 'kanalli') {
                    arkalikGen = icGenislik; 
                    arkalikYuk = icYukseklik;
                }
                parcalar.push({h: arkalikYuk, w: arkalikGen, count: 1, ad: 'Arkalık'});
                
                // Tip'e Özel Parçalar
                if (kabin.tip === 'cekmeceli' && kabin.cekmece > 0) {
                    const toplamFuga = (kabin.cekmece + 1) * fugaCm;
                    const cekmeceKapakYukseklik = (kabin.yuk - toplamFuga) / kabin.cekmece;
                    const cekmeceKapakGenislik = kabin.gen - (2 * fugaCm);
                    parcalar.push({h: cekmeceKapakYukseklik, w: cekmeceKapakGenislik, count: kabin.cekmece, ad: 'Çekmece Önü'});
                    
                    // Çekmece Kasası Hesaplaması
                    const kasaYukseklik = cekmeceKapakYukseklik - 4; // Kasa, kapaktan genellikle biraz daha kısa olur
                    const kasaDerinlik = 50; // Standart ray boyu varsayılanı
                    const kasaDisGenislik = icGenislik - rayBoslukCm; // Çekmece kasasının dıştan dışa genişliği
                    const kasaIcGenislik = kasaDisGenislik - (2 * kalinlikCm); // Kasa yanları arasına giren ön/arka parçanın genişliği
                    
                    // Kasa Yanları (2 adet/çekmece)
                    parcalar.push({h: kasaYukseklik, w: kasaDerinlik, count: kabin.cekmece * 2, ad: 'Kasa Yanı'});
                    // Kasa Ön ve Arka Parçaları (2 adet/çekmece)
                    parcalar.push({h: kasaYukseklik, w: kasaIcGenislik, count: kabin.cekmece * 2, ad: 'Kasa Ön/Arka'});
                    
                    // DÜZELTME: Eksik olan çekmece arkalığı (tabanı) parçası eklendi.
                    // Bu hesaplama, kasa ön/arka parçalarının, yan parçaların arasına girdiğini varsayar.
                    const dipGenislik = kasaIcGenislik;
                    const dipDerinlik = kasaDerinlik - (2 * kalinlikCm);
                    parcalar.push({h: dipDerinlik, w: dipGenislik, count: kabin.cekmece, ad: 'Çekmece Dibi'});

                } else { // Standart Kapaklı
                    // Raflar için arkada 1cm boşluk bırakmak montajı kolaylaştırır.
                    if (kabin.raf > 0) parcalar.push({ h: icGenislik, w: kabin.der - 1, count: kabin.raf, ad: 'Raf' });
                    // Tam açılır (dıştan) tek kapak hesabı
                    parcalar.push({h: kabin.yuk - (fugaCm*2), w: kabin.gen - (fugaCm*2), count: 1, ad: 'Kapak'});
                }
                return parcalar;
            });
            
            const parcaListesi = birleştirVeGrupla(tumParcalar);
            gosterKesimListesi(parcaListesi);
            plakaOnerisiYap(parcaListesi);
            const optimizasyonIcinParcalar = parcaListesi.flatMap(p => Array(p.count).fill({ w: p.w, h: p.h }));
            optimizeVeCiz(optimizasyonIcinParcalar, mevcutPlaka);
        }

        function plakaOnerisiYap(parcaListesi) {
            const toplamParcaAlani = parcaListesi.reduce((acc, p) => acc + (p.w * p.h * p.count), 0);
            if (toplamParcaAlani === 0) { document.getElementById('plakaOneriKutusu').classList.add('hidden'); return; }
            let enIyiOneri = { verim: 0, plaka: null, plakaSayisi: 0 };
            standartPlakalar.forEach(plaka => {
                const gerekenPlakaSayisi = Math.ceil(toplamParcaAlani / plaka.alan);
                const toplamPlakaAlani = gerekenPlakaSayisi * plaka.alan;
                const verim = (toplamParcaAlani / toplamPlakaAlani) * 100;
                if (verim > enIyiOneri.verim) { enIyiOneri = { verim, plaka, plakaSayisi: gerekenPlakaSayisi }; }
            });
            const onerikutusu = document.getElementById('plakaOneriKutusu');
            if (enIyiOneri.plaka) {
                document.getElementById('plakaOneriMetni').innerHTML = `~${enIyiOneri.plakaSayisi} adet <strong>${enIyiOneri.plaka.ad} (${enIyiOneri.plaka.w}x${enIyiOneri.plaka.h})</strong> plaka ile ~<strong class="text-green-600">%${enIyiOneri.verim.toFixed(0)}</strong> verim alabilirsiniz.`;
                document.getElementById('plakaOneriUygulaBtn').onclick = () => { mevcutPlaka = enIyiOneri.plaka; hesaplaGlobal(); };
                onerikutusu.classList.remove('hidden');
            } else { onerikutusu.classList.add('hidden'); }
        }

        function birleştirVeGrupla(parcalar) {
            const gruplu = {};
            parcalar.forEach(p => {
                const key = `${p.ad}_${p.h.toFixed(1)}x${p.w.toFixed(1)}`;
                if (gruplu[key]) gruplu[key].count += p.count;
                else gruplu[key] = { ...p };
            });
            return Object.values(gruplu);
        }

        function gosterKesimListesi(parcalar) {
            const tbody = document.getElementById('kesimListesiBody');
            tbody.innerHTML = '';
            parcalar.sort((a,b) => b.h - a.h || b.w - a.w);
            parcalar.forEach(p => { tbody.innerHTML += `<tr class="border-b last:border-b-0"><td class="p-2 font-bold">${p.count}</td><td class="p-2 font-medium">${p.ad}</td><td class="p-2">${p.h.toFixed(1)}x${p.w.toFixed(1)}</td></tr>`; });
        }
        
        function optimizeVeCiz(boxes, plaka) {
            const canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.style.aspectRatio = `${plaka.w} / ${plaka.h}`;
            const canvas = document.getElementById('kesimSemasiCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            if (boxes.length === 0) { document.getElementById('optimizasyonBilgi').innerHTML = ''; ctx.clearRect(0, 0, canvas.width, canvas.height); return; }
            potpack(boxes, plaka.w, plaka.h);
            const scale = Math.min(canvas.width / plaka.w, canvas.height / plaka.h);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 2; ctx.strokeRect(0, 0, plaka.w * scale, plaka.h * scale);
            let totalArea = 0;
            for (const box of boxes) {
                if (typeof box.x !== 'undefined') {
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.7)'; ctx.strokeStyle = '#1d4ed8'; ctx.lineWidth = 1;
                    const [rectX, rectY, rectW, rectH] = [box.x*scale, box.y*scale, box.w*scale, box.h*scale];
                    ctx.fillRect(rectX, rectY, rectW, rectH); ctx.strokeRect(rectX, rectY, rectW, rectH);
                    totalArea += box.w * box.h;
                }
            }
            const efficiency = (totalArea / (plaka.w * plaka.h)) * 100;
            document.getElementById('optimizasyonBilgi').innerHTML = `<p class="font-semibold">${plaka.w}x${plaka.h}</p><p>Verim: <strong class="text-green-600">${efficiency.toFixed(0)}%</strong></p>`;
        }
        
        document.addEventListener('DOMContentLoaded', projeyiGoster);
        window.addEventListener('resize', () => { if(projeKabinleri.length > 0) hesaplaGlobal(); });
    </script>
</body>
</html>

